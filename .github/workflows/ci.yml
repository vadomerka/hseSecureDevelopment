name: CI

on:
  pull_request:
  push:

defaults:
  run:
    shell: bash

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: Tests (py${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          pip install pytest-cov

      - name: Install pip-audit
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: pip install pip-audit

      - name: Run pytest with coverage
        run: |
          pytest tests/ --junitxml=pytest-${{ matrix.os }}-${{ matrix.python-version }}.xml \
            --cov=task_app --cov-report=xml:coverage-${{ matrix.os }}-${{ matrix.python-version }}.xml \
            --cov-report=term --durations=10

      - name: Generate metrics
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        env:
          PYTEST_XML: pytest-${{ matrix.os }}-${{ matrix.python-version }}.xml
        run: |
          python - <<'PY'
          import json
          import xml.etree.ElementTree as ET
          from pathlib import Path
          import os

          pytest_xml = Path(os.environ["PYTEST_XML"])
          metrics = {"collected": 0, "failures": 0, "errors": 0, "skipped": 0, "xfail": 0, "xpass": 0, "time": 0.0}
          if pytest_xml.exists():
              tree = ET.parse(pytest_xml)
              root = tree.getroot()
              suites = root.findall('testsuite') or [root]
              for s in suites:
                  metrics["collected"] += int(s.attrib.get('tests', 0))
                  metrics["failures"] += int(s.attrib.get('failures', 0))
                  metrics["errors"] += int(s.attrib.get('errors', 0))
                  metrics["skipped"] += int(s.attrib.get('skipped', 0))
                  metrics["time"] += float(s.attrib.get('time', 0.0) or 0.0)
                  for tc in s.findall('testcase'):
                      for sk in tc.findall('skipped'):
                          msg = (sk.attrib.get('type') or '') + ' ' + (sk.attrib.get('message') or '')
                          if 'xfail' in msg:
                              metrics["xfail"] += 1
                          elif 'xpass' in msg:
                              metrics["xpass"] += 1
          Path('metrics.json').write_text(json.dumps(metrics, indent=2))
          print('Metrics written to metrics.json:', metrics)
          PY

      - name: Security audit
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: pip-audit -f json -o pip-audit.json || true

      - name: Upload artifacts (primary combo)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            pytest-${{ matrix.os }}-${{ matrix.python-version }}.xml
            coverage-${{ matrix.os }}-${{ matrix.python-version }}.xml
            metrics.json
            pip-audit.json

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run Ruff
        run: ruff check --output-format=github .

      - name: Check Black formatting
        run: black --check .

      - name: Check isort
        run: isort --check-only .

      - name: Pre-commit
        run: pre-commit run --all-files
