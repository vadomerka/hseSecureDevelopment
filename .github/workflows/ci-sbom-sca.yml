name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - ".github/workflows/ci-sbom-sca.yml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM (Syft CycloneDX)
        run: |
          set -e
          WORK_DIR=$(pwd)
          echo "Working directory: $WORK_DIR"
          echo "Directory contents before SBOM generation:"
          ls -la EVIDENCE/P09/ || echo "EVIDENCE/P09/ does not exist yet"

          # Генерируем SBOM - используем tee для более надёжной записи
          docker run --rm \
            -v "$WORK_DIR:/work" \
            -w /work \
            anchore/syft:latest \
            packages dir:. -o cyclonedx-json | tee EVIDENCE/P09/sbom.json > /dev/null || \
          docker run --rm \
            -v "$WORK_DIR:/work" \
            -w /work \
            anchore/syft:latest \
            packages dir:. -o cyclonedx-json > EVIDENCE/P09/sbom.json

          # Проверяем, что файл создан и не пустой
          echo "Directory contents after SBOM generation:"
          ls -la EVIDENCE/P09/ || echo "EVIDENCE/P09/ still does not exist"

          if [ ! -f EVIDENCE/P09/sbom.json ]; then
            echo "ERROR: SBOM file was not created"
            echo "Trying to create it directly in container..."
            docker run --rm \
              -v "$WORK_DIR:/work" \
              -w /work \
              --entrypoint sh \
              anchore/syft:latest \
              -c "syft packages dir:. -o cyclonedx-json > /work/EVIDENCE/P09/sbom.json"
          fi

          if [ ! -f EVIDENCE/P09/sbom.json ]; then
            echo "ERROR: SBOM file was not created after all attempts"
            exit 1
          fi

          if [ ! -s EVIDENCE/P09/sbom.json ]; then
            echo "ERROR: SBOM file is empty"
            exit 1
          fi

          echo "SBOM generated successfully: $(ls -lh EVIDENCE/P09/sbom.json)"
          echo "First 100 chars of SBOM:"
          head -c 100 EVIDENCE/P09/sbom.json || true

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Verify SBOM exists
        run: |
          if [ ! -f EVIDENCE/P09/sbom.json ]; then
            echo "ERROR: SBOM file not found before SCA scan"
            exit 1
          fi
          echo "SBOM file exists: $(ls -lh EVIDENCE/P09/sbom.json)"

      - name: SCA Scan (Grype)
        run: |
          WORK_DIR=$(pwd)
          set +e  # Отключаем немедленный выход при ошибке для fallback логики

          # Проверяем, что SBOM файл существует и доступен
          echo "Checking SBOM file before SCA scan:"
          ls -lah EVIDENCE/P09/sbom.json
          file EVIDENCE/P09/sbom.json || true

          # Проверяем доступность файла внутри контейнера
          echo "Verifying file access in container:"
          docker run --rm \
            -v "$WORK_DIR:/work" \
            -w /work \
            --entrypoint sh \
            anchore/grype:latest \
            -c "ls -lah /work/EVIDENCE/P09/sbom.json && test -f /work/EVIDENCE/P09/sbom.json && echo 'File exists and is readable'"

          # Запускаем Grype - пробуем разные форматы указания SBOM
          echo "Running Grype SCA scan..."
          # Попытка 1: абсолютный путь с префиксом sbom:
          docker run --rm \
            -v "$WORK_DIR:/work" \
            -w /work \
            anchore/grype:latest \
            sbom:/work/EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json || {
            echo "Attempt 1 failed, trying relative path..."
            # Попытка 2: относительный путь (рабочая директория /work)
            docker run --rm \
              -v "$WORK_DIR:/work" \
              -w /work \
              anchore/grype:latest \
              sbom:EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json || {
              echo "Attempt 2 failed, trying stdin..."
              # Попытка 3: через stdin
              cat EVIDENCE/P09/sbom.json | docker run --rm -i \
                -v "$WORK_DIR:/work" \
                -w /work \
                anchore/grype:latest \
                sbom:stdin: -o json > EVIDENCE/P09/sca_report.json || {
                echo "Attempt 3 failed, trying file: format..."
                # Попытка 4: формат file:
                docker run --rm \
                  -v "$WORK_DIR:/work" \
                  -w /work \
                  anchore/grype:latest \
                  file:/work/EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json
              }
            }
          }

          # Включаем проверку ошибок обратно
          set -e

          # Проверяем результат
          if [ ! -f EVIDENCE/P09/sca_report.json ]; then
            echo "ERROR: SCA report was not created after all attempts"
            exit 1
          fi

          if [ ! -s EVIDENCE/P09/sca_report.json ]; then
            echo "ERROR: SCA report is empty"
            exit 1
          fi

          echo "SCA report generated successfully: $(ls -lh EVIDENCE/P09/sca_report.json)"

      - name: Generate SCA summary
        run: |
          echo "# SCA summary" > EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> EVIDENCE/P09/sca_summary.md
          echo "Commit: ${{ github.sha }}" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          if [ -f EVIDENCE/P09/sca_report.json ]; then
            echo "## Vulnerability Summary by Severity" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            jq '[.matches[].vulnerability.severity] | group_by(.) | map({(.[0]): length}) | add' \
              EVIDENCE/P09/sca_report.json >> EVIDENCE/P09/sca_summary.md 2>/dev/null || \
              echo "Unable to parse vulnerability summary (jq may be unavailable)" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "Full report available in: sca_report.json" >> EVIDENCE/P09/sca_summary.md
          else
            echo "SCA report not generated" >> EVIDENCE/P09/sca_summary.md
          fi

      - name: List generated artifacts
        if: always()
        run: |
          echo "Generated artifacts in EVIDENCE/P09/:"
          ls -lah EVIDENCE/P09/ || echo "Directory not found or empty"

      - name: Upload SBOM/SCA evidence
        # Пропускаем upload в act (локальном эмуляторе), так как он не может эмулировать GitHub Actions API
        # В реальных GitHub Actions этот шаг будет выполнен успешно
        if: always() && github.actor != 'nektos/act'
        uses: actions/upload-artifact@v4
        with:
          name: P09_EVIDENCE
          path: EVIDENCE/P09
          if-no-files-found: warn

      - name: Note about artifacts in act
        # Информационное сообщение для локального тестирования
        if: always() && github.actor == 'nektos/act'
        run: |
          echo "::notice::Artifacts are available locally in EVIDENCE/P09/ directory"
          echo "In real GitHub Actions, artifacts will be uploaded automatically"
          ls -lah EVIDENCE/P09/ || echo "No artifacts found"
