# ADR-001: RFC 7807 Детали проблем для ошибок

## Контекст
Текущий API возвращает произвольные обертки ошибок и стандартные ошибки валидации от FastAPI/Pydantic. Это приводит к несогласованным форматам и утечке внутренних деталей. Нам нужен согласованный, стандартизированный ответ об ошибке, который маскирует чувствительные данные и поддерживает корреляцию.

## Решение
- Принять формат RFC 7807 (application/problem+json) для всех ошибок.
- Включить поля: `type`, `title`, `status`, `detail`, `instance` и `correlation_id`.
- Генерировать `correlation_id` для каждого запроса из заголовка `X-Correlation-ID` или создать UUID v4. Эхо-отправлять его как заголовок ответа.
- Сопоставлять ошибки валидации фреймворка с общим `title` "Unprocessable Entity" и `detail` "Request validation failed".
- Сопоставлять ошибки приложения с типизированными проблемами с безопасными, нечувствительными деталями.

## Последствия
- Клиенты получают единообразные полезные нагрузки ошибок и могут отслеживать инциденты через `correlation_id`.
- Существующие тесты, ожидающие стандартную структуру `detail` от FastAPI, должны быть обновлены.

## Ссылки
- NFR: см. `docs/security-nfr/NFR.md`
- P04 F#/R#: F#-error-format, R#-mask-sensitive-details
- Тесты: `tests/test_errors.py`, `tests/test_rfc7807.py`
